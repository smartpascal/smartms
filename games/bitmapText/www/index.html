<!DOCTYPE HTML>
<html lang="en">
	<head>
		<title>Test test test</title>
		<meta charset="utf-8">

		<style type="text/css">
			body {
				background-color: #0072bc;
				margin: 0px;
				overflow: hidden;
			}
		</style>

	</head>
	<body>

	<button id="dis" onclick="new bitmapText('sigmarone', 'Bitmap Fonts!', 100, 100, 1, 0, 0); return false;">Click me</button>
<!--<canvas id='onScreen'></canvas>-->

<!--<script type="text/javascript" src="fontloader.js"></script>-->
<script>		
function q(a, b, k) {
  this.h = a;
  this.i = b;
  this.f = k || 0;
  this.c = new Image;
  this.c.setAttribute('crossOrigin', 'anonymous');	
  this.a = [];
  this.data = {};
}
function r(a, b, k) {
  a.c.src = a.h;
  a.data.b = {};
  var l = 0, g = a.i;
  var d = window.XMLHttpRequest ? new XMLHttpRequest : new ActiveXObject("Microsoft.XMLHTTP");
  d.open("GET", g, !1);
  d.send();
  var c = d.responseXML;
  g = c.getElementsByTagName("info")[0];
  d = c.getElementsByTagName("common")[0];
  a.data.font = g.getAttribute("face");
  a.data.size = parseInt(g.getAttribute("size"), 10);
  a.data.lineHeight = parseInt(d.getAttribute("lineHeight"), 10) + 0;
  g = a.frame ? a.frame.x : 0;
  d = a.frame ? a.frame.y : 0;
  c = c.getElementsByTagName("character");
  for (var e = 0; e < c.length; e++) {
    var f = b.charCodeAt(e) - 32;
    e < b.length && (a.a[e] = {x:g + parseInt(c[f].getAttribute("x"), 10), y:d + parseInt(c[f].getAttribute("y"), 10), width:parseInt(c[f].getAttribute("width"), 10), height:parseInt(c[f].getAttribute("height"), 10), j:parseInt(c[f].getAttribute("xoffset"), 10) / 1, l:parseInt(c[f].getAttribute("yoffset"), 10) / 1, g:(parseInt(c[f].getAttribute("xadvance"), 10) + 1) / 1}, l += a.a[e].g);
  }
  a.data.lineWidth = (l + a.f + 10) * k;
  a.data.b = a.a;
  return a.data;
}
function bitmapText(fontName, Text, left, top, scale, kerning, frame) {
	
  this.scale = scale || 1;
  this.f = kerning || 0;
  this.frame = frame || 0;


var f = new q("fonts/" + fontName + ".png", "fonts/" + fontName + ".xml", kerning);
fontName = r(f, Text, scale);
var t = fontName.lineHeight, u = fontName.lineWidth, h = (fontName).b;
  
var img = new Image();
img.setAttribute('crossOrigin', 'anonymous');	
img.onload = function() {

  
	var croppedURL = cropPlusExport(img, 0, 0, u, t);
	var cropImg = new Image();
	cropImg.setAttribute('crossOrigin', 'anonymous');	
	cropImg.src = croppedURL;
	document.body.appendChild(cropImg);
}
img.src = "fonts/sigmarone.png";

function cropPlusExport(img, cropX, cropY, cropWidth, cropHeight) {
	// create a temporary canvas sized to the cropped size
	var canvas1 = document.createElement('canvas');
	var ctx1 = canvas1.getContext('2d');
	canvas1.width = cropWidth;
	canvas1.height = cropHeight;
	// use the extended from of drawImage to draw the
	// cropped area to the temp canvas
	//ctx1.drawImage(img, cropX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);
	var b = t * scale;
	var c = 0;
	for (b = 0; b < (Text).length; b++) {
      var v = parseInt(h[b].x);
      var w = parseInt(h[b].y);
      var n = parseInt(h[b].width);
      var p = parseInt(h[b].height);
      var x = parseInt(h[b].j);
      var y = parseInt(h[b].l);
      var z = parseInt(h[b].g);
      ctx1.drawImage(f.c, v, w, n, p, c + x, y, n, p);
      c += z;
    }
	// return the .toDataURL of the temp canvas
	return (canvas1.toDataURL());
}
	
/*
  this.scale = scale || 1;
  this.f = kerning || 0;
  this.frame = frame || 0;
  var f = new q("fonts/" + fontName + ".png", "fonts/" + fontName + ".xml", kerning);
  fontName = r(f, Text, scale);
  var t = fontName.lineHeight, u = fontName.lineWidth, h = (fontName).b;
  var e = document.createElement("canvas");
  var img = new Image();
  var m = e.getContext("2d");  
  
  setTimeout(function() {
    var c = 0;
    var b = t * scale;
    
    e.width = u;
    e.height = b;
    m.scale(scale, scale);
    for (b = 0; b < (Text).length; b++) {
      var v = parseInt(h[b].x);
      var w = parseInt(h[b].y);
      var n = parseInt(h[b].width);
      var p = parseInt(h[b].height);
      var x = parseInt(h[b].j);
      var y = parseInt(h[b].l);
      var z = parseInt(h[b].g);
      m.drawImage(f.c, v, w, n, p, c + x, y, n, p);
      c += z;
    }
	img.src = e.getContext("2d").canvas.toDataURL("image/png");
  //  parent.setAttribute("style", "position:absolute; left:" + left + "px; top:" + top + "px;");
  //  parent.src = e.getContext("2d").canvas.toDataURL("image/png");

  }, 0);
  
  return img.src;
  */
}



</script>	

	</body>
</html>
